<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão - Acesso</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
         /* Cores IFC */
        :root {
            --ifc-green: #008000; /* Verde Principal - Ajuste se necessário */
            --ifc-gray-light: #f8f9fa;
            --ifc-gray-medium: #e9ecef;
            --ifc-gray-dark: #adb5bd;
            --ifc-success: #198754; /* Verde sucesso Bootstrap */
            --ifc-danger: #dc3545; /* Vermelho danger Bootstrap */
            --ifc-warning: #ffc107; /* Amarelo warning Bootstrap */
        }
        body { background-color: var(--ifc-gray-light); }
        .login-container { max-width: 400px; margin: 5rem auto; }
        .main-container { display: none; } 
        .actions-cell button { margin-right: 5px; }
        .badge { font-size: 0.9em; }
        th, td { white-space: nowrap; } 

        /* Ajustes de cor */
        .btn-primary {
            background-color: var(--ifc-green);
            border-color: var(--ifc-green);
        }
        .btn-primary:hover {
            background-color: #006400; /* Verde mais escuro no hover */
            border-color: #006400;
        }
         h1, h3 { color: var(--ifc-green); } /* Títulos em verde */
         
         .badge.bg-success { background-color: var(--ifc-success) !important; }
         .badge.bg-danger { background-color: var(--ifc-danger) !important; }
         .badge.bg-warning { background-color: var(--ifc-warning) !important; color: #000 !important; }

         /* Espaço para o Logo */
         .logo-container img {
             max-height: 60px; /* Ajuste a altura conforme necessário */
             width: auto;
             margin-bottom: 1rem;
         }
    </style>
</head>
<body>

    <div class="container login-container" id="login-section">
        <div class="card shadow-sm">
            <div class="card-body p-4 text-center">
                 <div class="logo-container">
                    <img src="/img/logo-ifc-concordia.png.png" alt="Logo IFC Concórdia">
                    </div>
                 <h3 class="card-title mb-4">Acesso ao Painel</h3>
                <form id="login-form">
                    <div class="mb-3">
                        <label for="password" class="form-label">Senha de Acesso</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Entrar</button>
                    </div>
                </form>
                <div id="login-error" class="text-danger mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div class="container mt-4 main-container" id="main-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
             <h1 class="display-6">Painel de Gestão V2</h1>
             <span class="text-muted">IFC Concórdia</span>
         </div>
        <div class="card shadow-sm mt-4">
            <div class="card-body">
                <div id="loading-message"><p>Carregando agendamentos...</p></div>
                <div id="table-container" class="table-responsive" style="display: none;">
                    <table class="table table-striped table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Data Visita</th>
                                <th>Escola</th>
                                <th>Cidade</th>
                                <th>Nº Alunos</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="agendamentos-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detalhesModal" tabindex="-1">
         <div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="modal-title"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="modal-body"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button></div></div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const SCRIPT_URL = "/.netlify/functions/agendamentos";
        let todosAgendamentos = [];

        document.addEventListener('DOMContentLoaded', function() {
            const loginSection = document.getElementById('login-section');
            const mainSection = document.getElementById('main-section');
            const loginForm = document.getElementById('login-form');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('login-error');
            const tbody = document.getElementById('agendamentos-tbody');
            const loadingMessage = document.getElementById('loading-message');
            const tableContainer = document.getElementById('table-container');
            const bsModal = new bootstrap.Modal(document.getElementById('detalhesModal'));

            loginForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const password = passwordInput.value;
                loginError.style.display = 'none';

                fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'login', password: password })
                })
                .then(response => response.json().then(data => ({ ok: response.ok, body: data })))
                .then(({ ok, body }) => {
                    if (ok && body.status === 'sucesso') {
                        sessionStorage.setItem('adminPassword', password);
                        todosAgendamentos = body.dados;
                        loginSection.style.display = 'none';
                        mainSection.style.display = 'block';
                        renderizarTabela();
                    } else {
                        throw new Error(body.message || 'Senha incorreta.');
                    }
                }).catch(error => {
                    loginError.textContent = error.message;
                    loginError.style.display = 'block';
                });
            });

            function renderizarTabela() {
                loadingMessage.style.display = 'none';
                tableContainer.style.display = 'block';
                tbody.innerHTML = '';
                todosAgendamentos.forEach(agendamento => {
                    const tr = document.createElement('tr');
                    tr.dataset.id = agendamento.ID_Agendamento;
                    const statusBadge = getStatusBadge(agendamento.Status);
                    const actionsButtons = getActionsButtons(agendamento);

                    let dataVisitaFormatada = 'Inválida';
                    if (agendamento.Data_Visita && typeof agendamento.Data_Visita === 'string' && agendamento.Data_Visita.includes('-')) {
                        const partes = agendamento.Data_Visita.split('-');
                        if (partes.length === 3) {
                             dataVisitaFormatada = `${partes[2]}/${partes[1]}/${partes[0]}`;
                        }
                    }
                    
                    tr.innerHTML = `
                        <td>${dataVisitaFormatada}</td> 
                        <td>${agendamento.Nome_Escola || '-'}</td>
                        <td>${agendamento.Cidade_Escola || '-'}</td>
                        <td>${agendamento.Qtd_Alunos || '-'}</td>
                        <td class="status-cell">${statusBadge}</td>
                        <td class="actions-cell">${actionsButtons}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            tbody.addEventListener('click', function(event) {
                const button = event.target.closest('button');
                if (!button) return;

                const id = button.dataset.id;
                const action = button.dataset.action;
                const agendamento = todosAgendamentos.find(a => a.ID_Agendamento === id);
                
                if (action === 'detalhes') {
                    document.getElementById('modal-title').textContent = `Detalhes: ${agendamento.Nome_Escola}`;
                    let dataVisitaModal = agendamento.Data_Visita ? new Date(agendamento.Data_Visita + 'T12:00:00').toLocaleDateString('pt-BR') : 'Inválida';
                    let dataSolicitacaoModal = agendamento.Data_Solicitacao ? new Date(agendamento.Data_Solicitacao).toLocaleString('pt-BR') : 'Inválida';

                    document.getElementById('modal-body').innerHTML = `<p><strong>ID:</strong> ${agendamento.ID_Agendamento}</p><p><strong>Data da Solicitação:</strong> ${dataSolicitacaoModal}</p><hr><p><strong>Escola:</strong> ${agendamento.Nome_Escola} (${agendamento.Cidade_Escola})</p><p><strong>Responsável:</strong> ${agendamento.Nome_Responsavel}</p><p><strong>Contato:</strong> ${agendamento.Email_Responsavel} / ${agendamento.Telefone_Responsavel}</p><hr><p><strong>Data da Visita:</strong> ${dataVisitaModal} (${agendamento.Periodo})</p><p><strong>Alunos:</strong> ${agendamento.Qtd_Alunos} (${agendamento.Faixa_Etaria} / ${agendamento.Ano_Letivo})</p><p><strong>Objetivo:</strong> ${agendamento.Objetivo_Visita}</p><p><strong>Almoço:</strong> ${agendamento.Pretende_Almocar}</p><p><strong>Observações:</strong> ${agendamento.Observacoes || 'Nenhuma'}</p>`;
                    bsModal.show();
                } else if (action === 'aprovar' || action === 'recusar') {
                    if (!confirm(`Tem certeza que deseja ${action} este agendamento?`)) return;
                    button.disabled = true;
                    button.textContent = 'Aguarde...';
                    const password = sessionStorage.getItem('adminPassword');

                    fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: action, id: id, password: password })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'sucesso') {
                            const agendamentoNaTela = todosAgendamentos.find(a => a.ID_Agendamento === id);
                            agendamentoNaTela.Status = (action === 'aprovar' ? 'Aprovado' : 'Recusado');
                            renderizarTabela();
                        } else { throw new Error(data.message); }
                    }).catch(error => {
                        alert('Ocorreu um erro ao atualizar o status: ' + error.message);
                        button.disabled = false; // Reabilita em caso de erro
                        button.textContent = action.charAt(0).toUpperCase() + action.slice(1);
                    });
                }
            });

            // FUNÇÃO PRESERVADA
            function getStatusBadge(status) {
                if (status === 'Aprovado') return `<span class="badge bg-success">${status}</span>`;
                if (status === 'Recusado') return `<span class="badge bg-danger">${status}</span>`;
                return `<span class="badge bg-warning text-dark">${status}</span>`; // Usa text-dark para contraste no amarelo
            }

            // FUNÇÃO PRESERVADA
            function getActionsButtons(agendamento) {
                let buttons = `<button class="btn btn-sm btn-info me-1" data-action="detalhes" data-id="${agendamento.ID_Agendamento}">Detalhes</button>`;
                if (agendamento.Status === 'Pendente') {
                    buttons += `<button class="btn btn-sm btn-success me-1" data-action="aprovar" data-id="${agendamento.ID_Agendamento}">Aprovar</button>`;
                    buttons += `<button class="btn btn-sm btn-danger" data-action="recusar" data-id="${agendamento.ID_Agendamento}">Recusar</button>`;
                }
                return buttons;
            }
        });
    </script>
</body>
</html>


