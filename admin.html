<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão - Agenda IFC Concórdia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .table-responsive { max-height: 70vh; }
        .badge { font-size: 0.9em; }
        .actions-cell button { margin-right: 5px; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="display-6">Painel de Gestão V2</h1>
        <div class="card shadow-sm mt-4">
            <div class="card-body">
                <div id="loading-message"><p>Carregando agendamentos...</p></div>
                <div id="table-container" class="table-responsive" style="display: none;">
                    <table class="table table-striped table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Data Visita</th>
                                <th>Escola</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="agendamentos-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detalhesModal" tabindex="-1">
        <div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="modal-title"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="modal-body"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button></div></div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const SCRIPT_URL = "/.netlify/functions/agendamentos";
        let todosAgendamentos = []; // Guarda os dados em memória

        document.addEventListener('DOMContentLoaded', function() {
            const tbody = document.getElementById('agendamentos-tbody');
            const loadingMessage = document.getElementById('loading-message');
            const tableContainer = document.getElementById('table-container');
            const bsModal = new bootstrap.Modal(document.getElementById('detalhesModal'));

            carregarAgendamentos();

            function carregarAgendamentos() {
                fetch(SCRIPT_URL)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'sucesso' && data.dados) {
                            todosAgendamentos = data.dados;
                            renderizarTabela();
                            loadingMessage.style.display = 'none';
                            tableContainer.style.display = 'block';
                        } else { throw new Error(data.message); }
                    }).catch(error => {
                        loadingMessage.innerHTML = `<p class="text-danger">Erro ao carregar os dados.</p>`;
                    });
            }

            function renderizarTabela() {
                tbody.innerHTML = '';
                todosAgendamentos.forEach(agendamento => {
                    const tr = document.createElement('tr');
                    tr.dataset.id = agendamento.ID_Agendamento; // Adiciona o ID na linha

                    const statusBadge = getStatusBadge(agendamento.Status);
                    const actionsButtons = getActionsButtons(agendamento);

                    tr.innerHTML = `
                        <td>${new Date(agendamento.Data_Visita + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
                        <td>${agendamento.Nome_Escola}</td>
                        <td class="status-cell">${statusBadge}</td>
                        <td class="actions-cell">${actionsButtons}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            tbody.addEventListener('click', function(event) {
                const button = event.target.closest('button');
                if (!button) return;

                const id = button.dataset.id;
                const action = button.dataset.action;
                const agendamento = todosAgendamentos.find(a => a.ID_Agendamento === id);

                if (action === 'detalhes') {
                    // Lógica do botão Detalhes
                    document.getElementById('modal-title').textContent = `Detalhes: ${agendamento.Nome_Escola}`;
                    document.getElementById('modal-body').innerHTML = `<p><strong>Responsável:</strong> ${agendamento.Nome_Responsavel}</p><p><strong>Contato:</strong> ${agendamento.Email_Responsavel}</p><p><strong>Alunos:</strong> ${agendamento.Qtd_Alunos}</p>`;
                    bsModal.show();
                } else if (action === 'aprovar' || action === 'recusar') {
                    // Lógica para Aprovar e Recusar
                    if (!confirm(`Tem certeza que deseja ${action} este agendamento?`)) return;

                    button.disabled = true;
                    button.textContent = 'Aguarde...';

                    fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: action, id: id })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if(data.status === 'sucesso') {
                            // Atualiza os dados na tela sem recarregar
                            const agendamentoNaTela = todosAgendamentos.find(a => a.ID_Agendamento === id);
                            agendamentoNaTela.Status = (action === 'aprovar' ? 'Aprovado' : 'Recusado');
                            renderizarTabela(); // Redesenha a tabela com o novo status
                        } else { throw new Error(data.message); }
                    }).catch(error => {
                        alert('Ocorreu um erro ao atualizar o status.');
                        button.disabled = false;
                        button.textContent = action.charAt(0).toUpperCase() + action.slice(1);
                    });
                }
            });

            function getStatusBadge(status) {
                if (status === 'Aprovado') return `<span class="badge bg-success">${status}</span>`;
                if (status === 'Recusado') return `<span class="badge bg-danger">${status}</span>`;
                return `<span class="badge bg-warning text-dark">${status}</span>`;
            }

            function getActionsButtons(agendamento) {
                let buttons = `<button class="btn btn-sm btn-info" data-action="detalhes" data-id="${agendamento.ID_Agendamento}">Detalhes</button>`;
                if (agendamento.Status === 'Pendente') {
                    buttons += `<button class="btn btn-sm btn-success" data-action="aprovar" data-id="${agendamento.ID_Agendamento}">Aprovar</button>`;
                    buttons += `<button class="btn btn-sm btn-danger" data-action="recusar" data-id="${agendamento.ID_Agendamento}">Recusar</button>`;
                }
                return buttons;
            }
        });
    </script>
</body>
</html>
